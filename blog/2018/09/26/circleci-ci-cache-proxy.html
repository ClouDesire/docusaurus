<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Dependencies caching on local CircleCI builds · cloudesire documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="At Cloudesire a couple of years ago we decided to switch from Jenkins to CircleCI. First of all, because we are lazy to self-maintain a server and secondly because it offers affordable prices."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Dependencies caching on local CircleCI builds · cloudesire documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.cloudesire.com/blog/2018/09/26/circleci-ci-cache-proxy.html"/><meta property="og:description" content="At Cloudesire a couple of years ago we decided to switch from Jenkins to CircleCI. First of all, because we are lazy to self-maintain a server and secondly because it offers affordable prices."/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-Y0QZTE1YQV"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments); }
              gtag('js', new Date());
              gtag('config', 'G-Y0QZTE1YQV');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo-cloudesire.png" alt="cloudesire documentation"/><h2 class="headerTitleWithLogo">cloudesire documentation</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/index.html" target="_self">Docs</a></li><li class=""><a href="/docs/api.html" target="_self">API</a></li><li class=""><a href="/docs/syndication.html" target="_self">Syndication</a></li><li class=""><a href="/docs/glossary.html" target="_self">Glossary</a></li><li class=""><a href="https://cloudesire.com" target="_self">Back to cloudesire.com</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Recent Posts</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Recent Posts</h3><ul class=""><li class="navListItem"><a class="navItem" href="/blog/2021/07/26/sso-graylog4-oauth2-proxy.html">How to setup SSO on Graylog 4 with oauth2-proxy</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/11/21/upgrade-node-version-circleci.html">How to upgrade node on CircleCI machine executor</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/10/29/introduction-traefik.html">Introduction to Traefik reverse proxy @ Container Day 2018, Verona</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/blog/2018/09/26/circleci-ci-cache-proxy.html">Dependencies caching on local CircleCI builds</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/08/29/openstack-integration.html">Selling and provisioning OpenStack tenants</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer postContainer blogContainer"><div class="wrapper"><div class="lonePost"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog/2018/09/26/circleci-ci-cache-proxy.html">Dependencies caching on local CircleCI builds</a></h1><p class="post-meta">September 26, 2018</p><div class="authorBlock"><p class="post-authorName"><a href="https://keybase.io/originof" target="_blank" rel="noreferrer noopener">Manuel Mazzuola</a></p></div></header><div><span><p>At Cloudesire a couple of years ago we decided to switch from Jenkins to CircleCI. First of all, because we are lazy to self-maintain a server and secondly because it offers affordable prices.</p>
<p>A great tool CircleCI provides is the <a href="https://circleci.com/docs/2.0/local-cli/">local CLI</a>.<br>
The <code>circleci</code> commands enable you to reproduce the CircleCI environment locally and run jobs as if they were running on the hosted application for more efficient debugging and configuration in the initial setup phase.<br>
The bad news about the local CLI is that the <code>restore_cache</code> key is <a href="https://circleci.com/docs/2.0/local-cli/#caching">ignored</a>.
While building you'll receive the message <code>Error: Skipping cache - error checking storage: not supported in the local builds</code> and dependencies are downloaded each time, shame 🕭 shame 🕭 shame 🕭.</p>
<p>A fast setup solution I currently use is to proxy <a href="https://www.docker.com/">docker</a> to a local <a href="https://www.nginx.com/">nginx</a> container that acts as cache layer.</p>
<h3><a class="anchor" aria-hidden="true" id="start-the-proxy-container"></a><a href="#start-the-proxy-container" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Start the proxy container</h3>
<p>Start the <a href="https://github.com/manuelmazzuola/nginx-cache/blob/master/Dockerfile">nginx-cache</a> container</p>
<pre><code class="hljs">docker run --name nginx-cache -d manuelmazzuola/nginx-cache
</code></pre>
<p>and get the internal IP by inspecting it with</p>
<pre><code class="hljs">docker inspect nginx-cache | grep IPAddress
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="proxy-docker-requests"></a><a href="#proxy-docker-requests" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Proxy docker requests</h3>
<p>Create or edit the file <code>~/.docker/config.json</code> and change it according to the following configuration where <code>{IP}</code> is the internal IP of the cache container:</p>
<pre><code class="hljs css language-json">{
 <span class="hljs-attr">"proxies"</span>:
 {
   <span class="hljs-attr">"default"</span>:
   {
     <span class="hljs-attr">"httpProxy"</span>: <span class="hljs-string">"http://{IP}:8080"</span>,
     <span class="hljs-attr">"noProxy"</span>: <span class="hljs-string">"127.0.0.1,localhost,{IP}"</span>
   }
 }
}
</code></pre>
<p>and test it by running the following twice</p>
<pre><code class="hljs">docker run --rm alpine/httpie --print=hH GET unpkg.com/react@16/umd/react.development.js Cache-Control:no-cache
</code></pre>
<p>the first response will contains <code>X-Cached: MISS</code> and the next responses should contain <code>X-Cached: HIT</code>, Eὕρηκα!<br>
But wait, why was the file cached even if <code>Cache-Control:nocache</code> is present? Our <code>nginx-cache</code> container ignores all the caching headers because some build tools, like maven, add the <code>Cache-Control:nocache</code> header to the requests it made ☹</p>
<p>That's it! Remember that only <code>http</code> requests will be cached, so if you want maven artifacts to be cached you could add an http mirror to your <code>$MAVEN_HOME/conf/settings.xml</code></p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central-secure<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://repo.maven.apache.org/maven2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>
</code></pre>
<p>or if you use npm/yarn run the following <code>npm config set registry http://registry.npmjs.org/</code>.</p>
<p>If you want to download your dependencies over <code>HTTP</code> only on your computer you could use a different config file by using <code>circle build -c my-custom-config</code> or inject an env. variable <code>circle build -e LOCAL_BUILD=1</code> that your build scripts will read and change the repositories according to the value.</p>
<!--truncate-->
</span></div></div><div class="blogSocialSection"></div></div><div class="blog-recent"><a class="button" href="/blog/">Recent Posts</a></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><div><h5>Pages</h5><a href="/docs/index.html">Documentation Index</a><a href="/docs/api-reference.html">API Reference</a><a href="/docs/platform.html">Platform modules</a><a href="/docs/opensource.html">Open Source</a><a href="https://www.cloudesire.com">Corporate website</a></div><div><h5>Social</h5><a href="https://twitter.com/cloudesire" target="_blank">Twitter</a><a href="https://fb.com/cloudesire" target="_blank">Facebook</a><a href="https://github.com/cloudesire" target="_blank">GitHub</a></div></section><section class="copyright"><span>Copyright © 2024 Cloudesire.com by Engineering D.HUB</span> </section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '06aaa65659156b0fd43caf8c5d9997e9',
                indexName: 'cloudesire',
                inputSelector: '#search_input_react'
              });
            </script></body></html>